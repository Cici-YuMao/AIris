<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶èŠå¤©ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-id-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .server-selector {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .heartbeat-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
            position: relative;
        }

        .heartbeat-indicator.active {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        .heartbeat-indicator.error {
            background: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            height: calc(100vh - 80px);
        }

        /* èŠå¤©åˆ—è¡¨ */
        .chat-list {
            width: 300px;
            background: #fff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }

        .chat-list-header {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            background: #fafafa;
        }

        .add-chat-form {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .chat-items {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-item:hover {
            background: #f8f8f8;
        }

        .chat-item.active {
            background: #e3f2fd;
            border-right: 3px solid #2196F3;
        }

        .chat-item-name {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }

        .chat-item-preview {
            font-size: 12px;
            color: #666;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* èŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #fafafa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-info h3 {
            color: #333;
            margin-bottom: 2px;
        }

        .chat-id {
            font-size: 12px;
            color: #666;
            font-family: monospace;
        }

        /* æ¶ˆæ¯åŒºåŸŸ */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9f9f9;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.sent {
            align-items: flex-end;
        }

        .message.received {
            align-items: flex-start;
        }

        .message.system {
            align-items: center;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.sent .message-bubble {
            background: #2196F3;
            color: white;
        }

        .message.received .message-bubble {
            background: white;
            border: 1px solid #e0e0e0;
            color: #333;
        }

        .message.system .message-bubble {
            background: #f0f0f0;
            color: #666;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 12px;
            max-width: 90%;
            text-align: center;
        }

        .message-info {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message-status {
            font-size: 10px;
            color: #4CAF50;
        }

        .message-status.pending {
            color: #FF9800;
        }

        .message-status.delivered {
            color: #4CAF50;
        }

        .message-status.read {
            color: #2196F3;
        }

        .message-status.failed {
            color: #f44336;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
        }

        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 10px 15px;
            resize: none;
            max-height: 100px;
            min-height: 40px;
            outline: none;
            font-family: inherit;
        }

        .message-input:focus {
            border-color: #2196F3;
        }

        .send-buttons {
            display: flex;
            gap: 5px;
        }

        /* æŒ‰é’®æ ·å¼ */
        button {
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976D2;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #eeeeee;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        /* è¾“å…¥æ¡†æ ·å¼ */
        input, select {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 14px;
            outline: none;
        }

        input:focus, select:focus {
            border-color: #2196F3;
        }

        /* å·¥å…·æç¤º */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .chat-list {
                width: 100%;
                height: 200px;
            }

            .toolbar {
                padding: 10px 15px;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
<!-- å·¥å…·æ  -->
<div class="toolbar">
    <div class="user-info">
        <div class="user-id-container">
            <label>ç”¨æˆ·ID:</label>
            <input type="text" id="userId" placeholder="è¾“å…¥IDæˆ–è‡ªåŠ¨ç”Ÿæˆ" style="width: 200px;">
            <button class="btn-secondary btn-small" onclick="generateUserId()">ç”ŸæˆUUID</button>
        </div>
    </div>

    <div class="server-selector">
        <label>æœåŠ¡å™¨:</label>
        <select id="serverNode">
            <option value="9531">Node 1 (9531)</option>
            <option value="9532">Node 2 (9532)</option>
            <option value="9533">Node 3 (9533)</option>
        </select>
    </div>

    <div class="connection-status">
        <div class="tooltip">
            <div class="heartbeat-indicator" id="heartbeatIndicator"></div>
            <span class="tooltiptext">å¿ƒè·³çŠ¶æ€</span>
        </div>
        <button id="connectBtn" class="btn-primary" onclick="toggleConnection()">è¿æ¥</button>
        <span id="connectionStatus">æœªè¿æ¥</span>
    </div>
</div>

<!-- ä¸»è¦å†…å®¹ -->
<div class="main-content">
    <!-- èŠå¤©åˆ—è¡¨ -->
    <div class="chat-list">
        <div class="chat-list-header">
            <h4>èŠå¤©åˆ—è¡¨</h4>
            <div class="add-chat-form">
                <input type="text" id="newReceiverInput" placeholder="è¾“å…¥ç”¨æˆ·UUID">
                <button class="btn-secondary btn-small" onclick="addChat()">æ·»åŠ </button>
            </div>
        </div>
        <div class="chat-items" id="chatItems">
            <!-- èŠå¤©é¡¹ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- èŠå¤©åŒºåŸŸ -->
    <div class="chat-area">
        <div class="chat-header">
            <div class="chat-info">
                <h3 id="currentChatName">è¯·é€‰æ‹©æˆ–æ·»åŠ èŠå¤©</h3>
                <div class="chat-id" id="currentChatId"></div>
            </div>
            <div>
                <button class="btn-secondary btn-small" onclick="sendRandomMessage()">éšæœºæ¶ˆæ¯</button>
                <button class="btn-secondary btn-small" onclick="testMessageFailure()">æµ‹è¯•å‘é€å¤±è´¥</button>
                <button class="btn-secondary btn-small" onclick="testStatusOptimization()">æµ‹è¯•çŠ¶æ€ä¼˜åŒ–</button>
                <button class="btn-secondary btn-small" onclick="toggleDebugPanel()">è°ƒè¯•é¢æ¿</button>
                <button class="btn-secondary btn-small" onclick="showDebugInfo()">è°ƒè¯•ä¿¡æ¯</button>
            </div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <div class="message system">
                <div class="message-bubble">æ¬¢è¿ä½¿ç”¨å®æ—¶èŠå¤©ç³»ç»Ÿ</div>
            </div>
        </div>

        <!-- è°ƒè¯•é¢æ¿ -->
        <div id="debugPanel" style="display: none; background: #f0f0f0; border-top: 1px solid #ddd; padding: 10px; max-height: 200px; overflow-y: auto;">
            <div style="font-weight: bold; margin-bottom: 5px;">è°ƒè¯•ä¿¡æ¯:</div>
            <div id="debugContent" style="font-size: 12px; font-family: monospace;">
                è°ƒè¯•é¢æ¿å·²æ¿€æ´»...
            </div>
            <button class="btn-secondary btn-small" onclick="clearDebugLog()" style="margin-top: 5px;">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="input-area">
            <div class="input-container">
                    <textarea class="message-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..."
                              onkeydown="handleInputKeydown(event)"></textarea>
                <div class="send-buttons">
                    <button class="btn-primary" onclick="sendMessage()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // å…¨å±€å˜é‡
    let ws = null;
    let currentUserId = '';
    let currentReceiverId = '';
    let currentChatId = '';
    let heartbeatTimer = null;
    let chats = {}; // å­˜å‚¨æ‰€æœ‰èŠå¤©
    let messageStatuses = {}; // å­˜å‚¨æ¶ˆæ¯çŠ¶æ€
    let tempIdToRealIdMap = {}; // ä¸´æ—¶IDåˆ°çœŸå®IDçš„æ˜ å°„
    let pendingMessages = {}; // å¾…ç¡®è®¤çš„æ¶ˆæ¯ï¼ˆä¸´æ—¶ID -> æ¶ˆæ¯å†…å®¹ï¼‰

    // éšæœºæ¶ˆæ¯æ•°ç»„
    const randomMessages = [
        'Hello! ğŸ‘‹', 'Hi there!', 'How are you?', 'Good morning â˜€ï¸', 'Good evening ğŸŒ™',
        'Nice to meet you!', 'What\'s up?', 'See you later!', 'Take care! ğŸ’™',
        'Have a good day!', 'Thanks! ğŸ™', 'You\'re welcome!', 'No problem!',
        'Awesome! ğŸ‰', 'Great!', 'Perfect! âœ¨', 'Amazing!', 'Wonderful! ğŸŒŸ'
    ];

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = function() {
        loadUserIdFromStorage();
        loadChatsFromStorage();
        renderChatList();
    };

    // ä»localStorageåŠ è½½ç”¨æˆ·ID
    function loadUserIdFromStorage() {
        const savedUserId = localStorage.getItem('chatUserId');
        if (savedUserId) {
            document.getElementById('userId').value = savedUserId;
            currentUserId = savedUserId;
        }
    }

    // ç”Ÿæˆç”¨æˆ·UUID
    function generateUserId() {
        const uuid = generateUUID();
        document.getElementById('userId').value = uuid;
        currentUserId = uuid;
        localStorage.setItem('chatUserId', uuid);
    }

    // ç”ŸæˆUUID
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // ç”ŸæˆèŠå¤©ID
    function generateChatId(userId1, userId2) {
        const sortedIds = [userId1, userId2].sort();
        return `chat_${sortedIds[0]}_${sortedIds[1]}`;
    }

    // åˆ‡æ¢è¿æ¥çŠ¶æ€
    function toggleConnection() {
        if (ws && ws.readyState === WebSocket.OPEN) {
            disconnect();
        } else {
            connect();
        }
    }

    // è¿æ¥WebSocket
    function connect() {
        const userIdInput = document.getElementById('userId').value.trim();
        if (!userIdInput) {
            alert('è¯·è¾“å…¥ç”¨æˆ·IDæˆ–ç”ŸæˆUUID');
            return;
        }

        currentUserId = userIdInput;
        localStorage.setItem('chatUserId', currentUserId);

        const serverPort = document.getElementById('serverNode').value;
        const wsUrl = `ws://localhost:${serverPort}/ws/chat?userId=${currentUserId}`;
        // const wsUrl = `wss://mm-closure-waste-cow.trycloudflare.com/ws/chat?userId=${currentUserId}`;

        ws = new WebSocket(wsUrl);


        ws.onopen = function() {
            updateConnectionStatus('å·²è¿æ¥', true);
            addSystemMessage('è¿æ¥æˆåŠŸ');
            startHeartbeat();
        };

        ws.onmessage = function(event) {
            const message = JSON.parse(event.data);
            handleMessage(message);
        };

        ws.onclose = function() {
            updateConnectionStatus('å·²æ–­å¼€', false);
            addSystemMessage('è¿æ¥å·²æ–­å¼€');
            stopHeartbeat();
        };

        ws.onerror = function(error) {
            updateConnectionStatus('è¿æ¥é”™è¯¯', false);
            addSystemMessage('è¿æ¥é”™è¯¯: ' + error);
        };
    }

    // æ–­å¼€è¿æ¥
    function disconnect() {
        if (ws) {
            stopHeartbeat();
            ws.close();
            ws = null;
        }
    }

    // æ›´æ–°è¿æ¥çŠ¶æ€
    function updateConnectionStatus(status, connected) {
        document.getElementById('connectionStatus').textContent = status;
        document.getElementById('connectBtn').textContent = connected ? 'æ–­å¼€' : 'è¿æ¥';
        document.getElementById('connectBtn').className = connected ? 'btn-secondary' : 'btn-primary';

        const indicator = document.getElementById('heartbeatIndicator');
        if (connected) {
            indicator.className = 'heartbeat-indicator active';
        } else {
            indicator.className = 'heartbeat-indicator error';
        }
    }

    // å¼€å§‹å¿ƒè·³
    function startHeartbeat() {
        stopHeartbeat();
        heartbeatTimer = setInterval(function() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const heartbeatMessage = {
                    type: 'HEARTBEAT',
                    content: 'ping',
                    timestamp: Date.now()
                };
                ws.send(JSON.stringify(heartbeatMessage));
            }
        }, 25000); // 25ç§’é—´éš”
    }

    // åœæ­¢å¿ƒè·³
    function stopHeartbeat() {
        if (heartbeatTimer) {
            clearInterval(heartbeatTimer);
            heartbeatTimer = null;
        }
    }

    // å¤„ç†æ¶ˆæ¯
    function handleMessage(message) {
        debugLog('æ”¶åˆ°æ¶ˆæ¯: ' + JSON.stringify(message));
        switch (message.type) {
            case 'CONNECTED':
                addSystemMessage(message.content);
                break;
            case 'CHAT_MESSAGE':
                if (message.senderId === 'system') {
                    // å…¼å®¹æ—§ç‰ˆæœ¬çš„ç³»ç»Ÿæ¶ˆæ¯å¤„ç†
                    addSystemMessage(message.content);
                } else {
                    // æ¥æ”¶åˆ°çš„æ¶ˆæ¯
                    addReceivedMessage(message);
                    // è‡ªåŠ¨å‘é€å·²è¯»å›æ‰§
                    sendReadReceipt(message);
                }
                break;
            case 'MESSAGE_ACK':
                // å¤„ç†æ–°çš„æ¶ˆæ¯ç¡®è®¤ç±»å‹
                handleMessageAck(message);
                break;
            case 'HEARTBEAT_ACK':
                // å¿ƒè·³å“åº”ï¼Œæ›´æ–°å¿ƒè·³æŒ‡ç¤ºå™¨
                const indicator = document.getElementById('heartbeatIndicator');
                indicator.className = 'heartbeat-indicator active';
                break;
            case 'READ_RECEIPT':
                // å·²è¯»å›æ‰§
                debugLog('æ”¶åˆ°å·²è¯»å›æ‰§: ' + JSON.stringify(message));
                const readMessageId = message.extraData?.messageId;
                if (readMessageId) {
                    updateMessageStatus(readMessageId, 'read');
                }
                break;
            case 'ERROR':
                // å¤„ç†é”™è¯¯æ¶ˆæ¯ï¼Œå¯èƒ½åŒ…å«tempMessageId
                handleErrorMessage(message);
                break;
            case 'SYSTEM_NOTIFICATION':
                // å¤„ç†ç³»ç»Ÿé€šçŸ¥
                addSystemMessage(message.content);
                break;
            default:
                debugLog('æœªçŸ¥æ¶ˆæ¯ç±»å‹: ' + JSON.stringify(message));
                addSystemMessage('æœªçŸ¥æ¶ˆæ¯: ' + JSON.stringify(message));
        }
    }

    // å¤„ç†æ¶ˆæ¯ç¡®è®¤
    function handleMessageAck(message) {
        const tempMessageId = message.tempMessageId;
        const realMessageId = message.messageId;

        if (tempMessageId && realMessageId) {
            debugLog(`æ”¶åˆ°æ¶ˆæ¯ç¡®è®¤: ${tempMessageId} -> ${realMessageId}`);

            // å»ºç«‹æ˜ å°„å…³ç³»
            tempIdToRealIdMap[tempMessageId] = realMessageId;

            // æ›´æ–°æ¶ˆæ¯å…ƒç´ çš„ID
            updateMessageId(tempMessageId, realMessageId);

            // æ›´æ–°çŠ¶æ€ä¸ºå·²é€è¾¾
            updateMessageStatus(realMessageId, 'delivered');

            // æ¸…ç†å¾…ç¡®è®¤æ¶ˆæ¯
            delete pendingMessages[tempMessageId];

            debugLog(`æ¶ˆæ¯ç¡®è®¤å¤„ç†å®Œæˆ: ${tempMessageId} -> ${realMessageId}`);
        } else {
            debugLog('æ¶ˆæ¯ç¡®è®¤æ ¼å¼é”™è¯¯: ' + JSON.stringify(message));
        }
    }

    // å¤„ç†é”™è¯¯æ¶ˆæ¯
    function handleErrorMessage(message) {
        const tempMessageId = message.tempMessageId;
        const errorContent = message.content;

        debugLog(`æ”¶åˆ°é”™è¯¯æ¶ˆæ¯: ${errorContent}, tempMessageId: ${tempMessageId}`);

        if (tempMessageId && pendingMessages[tempMessageId]) {
            // æ‰¾åˆ°å¯¹åº”çš„å¾…ç¡®è®¤æ¶ˆæ¯ï¼Œæ ‡è®°ä¸ºå¤±è´¥
            updateMessageStatus(tempMessageId, 'failed');

            // æ¸…ç†å¾…ç¡®è®¤æ¶ˆæ¯
            delete pendingMessages[tempMessageId];

            // æ˜¾ç¤ºé”™è¯¯æç¤º
            addSystemMessage(`æ¶ˆæ¯å‘é€å¤±è´¥: ${errorContent}`);

            debugLog(`æ¶ˆæ¯å‘é€å¤±è´¥: ${tempMessageId}`);
        } else {
            // é€šç”¨é”™è¯¯æ¶ˆæ¯
            addSystemMessage('é”™è¯¯: ' + errorContent);
        }
    }

    // æ›´æ–°æ¶ˆæ¯IDï¼ˆä»ä¸´æ—¶IDæ›´æ–°ä¸ºçœŸå®IDï¼‰
    function updateMessageId(tempId, realId) {
        debugLog(`æ›´æ–°æ¶ˆæ¯ID: ${tempId} -> ${realId}`);

        // æ›´æ–°DOMå…ƒç´ çš„data-message-idå±æ€§
        const messageElement = document.querySelector(`[data-message-id="${tempId}"]`);
        if (messageElement) {
            messageElement.setAttribute('data-message-id', realId);
            debugLog(`DOMå…ƒç´ IDå·²æ›´æ–°: ${tempId} -> ${realId}`);
        } else {
            debugLog(`æœªæ‰¾åˆ°DOMå…ƒç´ : ${tempId}`);
        }

        // æ›´æ–°èŠå¤©è®°å½•ä¸­çš„æ¶ˆæ¯ID
        if (chats[currentChatId]) {
            const messages = chats[currentChatId].messages;
            for (let i = 0; i < messages.length; i++) {
                if (messages[i].id === tempId) {
                    messages[i].id = realId;
                    debugLog(`èŠå¤©è®°å½•ä¸­çš„æ¶ˆæ¯IDå·²æ›´æ–°: ${tempId} -> ${realId}`);
                    break;
                }
            }
            saveChatsToStorage();
        }

        // æ›´æ–°æ¶ˆæ¯çŠ¶æ€æ˜ å°„
        if (messageStatuses[tempId]) {
            messageStatuses[realId] = messageStatuses[tempId];
            delete messageStatuses[tempId];
            debugLog(`æ¶ˆæ¯çŠ¶æ€æ˜ å°„å·²æ›´æ–°: ${tempId} -> ${realId}`);
        }
    }

    // æ·»åŠ èŠå¤©
    function addChat() {
        const receiverInput = document.getElementById('newReceiverInput');
        const receiverId = receiverInput.value.trim();

        if (!receiverId) {
            alert('è¯·è¾“å…¥æ¥æ”¶è€…UUID');
            return;
        }

        if (receiverId === currentUserId) {
            alert('ä¸èƒ½æ·»åŠ è‡ªå·±ä¸ºèŠå¤©å¯¹è±¡');
            return;
        }

        const chatId = generateChatId(currentUserId, receiverId);

        if (!chats[chatId]) {
            chats[chatId] = {
                receiverId: receiverId,
                messages: [],
                lastMessage: '',
                lastTime: Date.now()
            };
            saveChatsToStorage();
            renderChatList();
        }

        selectChat(chatId);
        receiverInput.value = '';
    }

    // é€‰æ‹©èŠå¤©
    function selectChat(chatId) {
        currentChatId = chatId;
        const chat = chats[chatId];
        if (chat) {
            currentReceiverId = chat.receiverId;
            document.getElementById('currentChatName').textContent = `ä¸ ${chat.receiverId} çš„èŠå¤©`;
            document.getElementById('currentChatId').textContent = chatId;

            // æ›´æ–°èŠå¤©åˆ—è¡¨ä¸­çš„æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-chat-id="${chatId}"]`)?.classList.add('active');

            // æ¸²æŸ“æ¶ˆæ¯
            renderMessages();
        }
    }

    // æ¸²æŸ“èŠå¤©åˆ—è¡¨
    function renderChatList() {
        const chatItems = document.getElementById('chatItems');
        chatItems.innerHTML = '';

        Object.keys(chats).forEach(chatId => {
            const chat = chats[chatId];
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.setAttribute('data-chat-id', chatId);
            chatItem.onclick = () => selectChat(chatId);

            chatItem.innerHTML = `
                    <div class="chat-item-name">${chat.receiverId}</div>
                    <div class="chat-item-preview">${chat.lastMessage || 'æš‚æ— æ¶ˆæ¯'}</div>
                `;

            chatItems.appendChild(chatItem);
        });
    }

    // æ¸²æŸ“æ¶ˆæ¯
    function renderMessages() {
        const container = document.getElementById('messagesContainer');

        // æ¸…ç©ºç°æœ‰æ¶ˆæ¯ï¼ˆä¿ç•™æ¬¢è¿æ¶ˆæ¯ï¼‰
        const welcomeMessage = container.querySelector('.message.system');
        container.innerHTML = '';
        if (welcomeMessage) {
            container.appendChild(welcomeMessage);
        }

        if (!currentChatId || !chats[currentChatId]) return;

        const chat = chats[currentChatId];

        // æ‰¾åˆ°æœ€åä¸€æ¡å·²é€è¾¾å’Œå·²è¯»çš„æ¶ˆæ¯
        let lastDeliveredIndex = -1;
        let lastReadIndex = -1;

        // ä»åå¾€å‰éå†ï¼Œæ‰¾åˆ°æœ€åçš„çŠ¶æ€æ¶ˆæ¯
        for (let i = chat.messages.length - 1; i >= 0; i--) {
            const msg = chat.messages[i];
            if (msg.type === 'sent') {
                const status = messageStatuses[msg.id];
                if (status === 'read' && lastReadIndex === -1) {
                    lastReadIndex = i;
                }
                if ((status === 'delivered' || status === 'read') && lastDeliveredIndex === -1) {
                    lastDeliveredIndex = i;
                }
            }
        }

        // æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
        chat.messages.forEach((msg, index) => {
            const messageElement = createMessageElement(msg, index, lastDeliveredIndex, lastReadIndex);
            container.appendChild(messageElement);
        });

        // æ»šåŠ¨åˆ°åº•éƒ¨
        container.scrollTop = container.scrollHeight;
    }

    // åˆ›å»ºæ¶ˆæ¯å…ƒç´ ï¼ˆå¢åŠ çŠ¶æ€æ˜¾ç¤ºé€»è¾‘ï¼‰
    function createMessageElement(msg, messageIndex = -1, lastDeliveredIndex = -1, lastReadIndex = -1) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${msg.type}`;
        messageDiv.setAttribute('data-message-id', msg.id);

        if (msg.type === 'system') {
            messageDiv.innerHTML = `<div class="message-bubble">${msg.content}</div>`;
        } else {
            const status = messageStatuses[msg.id];
            const timeStr = new Date(msg.timestamp).toLocaleTimeString();

            // åªä¸ºå‘é€çš„æ¶ˆæ¯æ˜¾ç¤ºçŠ¶æ€ï¼Œå¹¶ä¸”åº”ç”¨æ˜¾ç¤ºé€»è¾‘
            let statusHtml = '';
            if (msg.type === 'sent') {
                let shouldShowStatus = false;
                let statusToShow = status;

                if (status === 'pending' || status === 'failed') {
                    // pendingå’ŒfailedçŠ¶æ€å§‹ç»ˆæ˜¾ç¤º
                    shouldShowStatus = true;
                } else if (status === 'read' && messageIndex === lastReadIndex) {
                    // åªåœ¨æœ€åä¸€æ¡å·²è¯»æ¶ˆæ¯æ˜¾ç¤ºå·²è¯»çŠ¶æ€
                    shouldShowStatus = true;
                } else if (status === 'delivered' && messageIndex === lastDeliveredIndex && lastReadIndex === -1) {
                    // åªåœ¨æœ€åä¸€æ¡å·²é€è¾¾æ¶ˆæ¯æ˜¾ç¤ºå·²é€è¾¾çŠ¶æ€ï¼ˆä¸”æ²¡æœ‰å·²è¯»æ¶ˆæ¯æ—¶ï¼‰
                    shouldShowStatus = true;
                }

                if (shouldShowStatus) {
                    const statusText = getStatusText(msg.id);
                    statusHtml = `<span class="message-status ${status || ''}">${statusText}</span>`;
                }
            }

            messageDiv.innerHTML = `
                    <div class="message-bubble">${msg.content}</div>
                    <div class="message-info">
                        <span>${timeStr}</span>
                        ${statusHtml}
                    </div>
                `;
        }

        return messageDiv;
    }

    // è·å–æ¶ˆæ¯çŠ¶æ€æ–‡æœ¬
    function getStatusText(messageId) {
        const status = messageStatuses[messageId];
        switch (status) {
            case 'pending': return 'â³ å‘é€ä¸­';
            case 'delivered': return 'âœ“ å·²é€è¾¾';
            case 'read': return 'âœ“âœ“ å·²è¯»';
            case 'failed': return 'âŒ å‘é€å¤±è´¥';
            default: return '';
        }
    }

    // æ›´æ–°æ¶ˆæ¯çŠ¶æ€
    function updateMessageStatus(messageId, status) {
        if (messageId) {
            debugLog(`æ›´æ–°æ¶ˆæ¯çŠ¶æ€: ${messageId} -> ${status}`);
            messageStatuses[messageId] = status;
            saveChatsToStorage(); // ä¿å­˜çŠ¶æ€æ›´æ–°

            // å¦‚æœæ˜¯deliveredæˆ–readçŠ¶æ€ï¼Œé‡æ–°æ¸²æŸ“æ¶ˆæ¯ä»¥åº”ç”¨æ˜¾ç¤ºé€»è¾‘
            if (status === 'delivered' || status === 'read') {
                debugLog(`é‡æ–°æ¸²æŸ“æ¶ˆæ¯ä»¥åº”ç”¨${status}çŠ¶æ€æ˜¾ç¤ºé€»è¾‘`);
                renderMessages();
            } else {
                // å¯¹äºpendingå’ŒfailedçŠ¶æ€ï¼Œç›´æ¥æ›´æ–°å•ä¸ªæ¶ˆæ¯å…ƒç´ 
                updateSingleMessageStatus(messageId, status);
            }
        }
    }

    // æ›´æ–°å•ä¸ªæ¶ˆæ¯çš„çŠ¶æ€æ˜¾ç¤º
    function updateSingleMessageStatus(messageId, status) {
        const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (messageElement) {
            debugLog(`æ‰¾åˆ°æ¶ˆæ¯å…ƒç´ : ${messageId}`);
            const statusElement = messageElement.querySelector('.message-status');
            if (statusElement) {
                // æ›´æ–°çŠ¶æ€æ–‡æœ¬å’ŒCSSç±»
                statusElement.textContent = getStatusText(messageId);
                statusElement.className = `message-status ${status}`;
                debugLog(`æ›´æ–°çŠ¶æ€æ–‡æœ¬å’Œæ ·å¼: ${getStatusText(messageId)}, class: ${status}`);
            } else {
                // å¦‚æœçŠ¶æ€å…ƒç´ ä¸å­˜åœ¨ï¼Œé‡æ–°æ¸²æŸ“è¯¥æ¶ˆæ¯
                const messageInfo = messageElement.querySelector('.message-info');
                if (messageInfo) {
                    const statusText = getStatusText(messageId);
                    if (statusText) {
                        const newStatusElement = document.createElement('span');
                        newStatusElement.className = `message-status ${status}`;
                        newStatusElement.textContent = statusText;
                        messageInfo.appendChild(newStatusElement);
                        debugLog(`åˆ›å»ºæ–°çŠ¶æ€å…ƒç´ : ${statusText}, class: ${status}`);
                    }
                }
            }
        } else {
            debugLog(`æœªæ‰¾åˆ°æ¶ˆæ¯å…ƒç´ : ${messageId}`);
        }
    }

    // å‘é€æ¶ˆæ¯
    function sendMessage(content = null) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert('è¯·å…ˆè¿æ¥WebSocket');
            return;
        }

        if (!currentReceiverId || !currentChatId) {
            alert('è¯·å…ˆé€‰æ‹©èŠå¤©å¯¹è±¡');
            return;
        }

        const messageInput = document.getElementById('messageInput');
        const messageContent = content || messageInput.value.trim();

        if (!messageContent) {
            return;
        }

        // ç”Ÿæˆä¸´æ—¶IDï¼Œç­‰å¾…æœåŠ¡å™¨è¿”å›çœŸå®ID
        const tempMessageId = generateUUID();
        const message = {
            type: 'CHAT_MESSAGE',
            receiverId: currentReceiverId,
            chatId: currentChatId,
            content: messageContent,
            tempMessageId: tempMessageId, // ä¸´æ—¶IDç”¨äºåŒ¹é…å“åº”
            timestamp: Date.now()
        };

        debugLog('å‘é€æ¶ˆæ¯: ' + JSON.stringify(message));
        ws.send(JSON.stringify(message));

        // ä¿å­˜å¾…ç¡®è®¤çš„æ¶ˆæ¯
        pendingMessages[tempMessageId] = {
            content: messageContent,
            chatId: currentChatId,
            receiverId: currentReceiverId,
            timestamp: Date.now()
        };

        // å…ˆç”¨ä¸´æ—¶IDæ·»åŠ åˆ°æœ¬åœ°èŠå¤©è®°å½•
        addSentMessage(messageContent, tempMessageId);

        // æ¸…ç©ºè¾“å…¥æ¡†
        if (!content) {
            messageInput.value = '';
        }
    }

    // æ·»åŠ å‘é€çš„æ¶ˆæ¯
    function addSentMessage(content, messageId) {
        const msg = {
            id: messageId,
            type: 'sent',
            content: content,
            timestamp: Date.now()
        };

        // è®¾ç½®åˆå§‹çŠ¶æ€ä¸ºå‘é€ä¸­
        messageStatuses[messageId] = 'pending';

        if (chats[currentChatId]) {
            chats[currentChatId].messages.push(msg);
            chats[currentChatId].lastMessage = content;
            chats[currentChatId].lastTime = Date.now();
            saveChatsToStorage();
            renderMessages();
            renderChatList();
        }

        debugLog('æ·»åŠ å‘é€æ¶ˆæ¯ï¼ŒID: ' + messageId + ', çŠ¶æ€: pending');
    }

    // æ·»åŠ æ¥æ”¶çš„æ¶ˆæ¯
    function addReceivedMessage(message) {
        const chatId = message.chatId;
        const senderId = message.senderId;

        // å¦‚æœèŠå¤©ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°èŠå¤©
        if (!chats[chatId]) {
            chats[chatId] = {
                receiverId: senderId,
                messages: [],
                lastMessage: '',
                lastTime: Date.now()
            };
        }

        const msg = {
            id: message.messageId,
            type: 'received',
            content: message.content,
            timestamp: message.timestamp || Date.now()
        };

        chats[chatId].messages.push(msg);
        chats[chatId].lastMessage = message.content;
        chats[chatId].lastTime = msg.timestamp;

        saveChatsToStorage();
        renderChatList();

        // å¦‚æœå½“å‰èŠå¤©æ˜¯è¿™ä¸ªèŠå¤©ï¼Œé‡æ–°æ¸²æŸ“æ¶ˆæ¯
        if (currentChatId === chatId) {
            renderMessages();
        }
    }

    // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
    function addSystemMessage(content) {
        if (currentChatId && chats[currentChatId]) {
            const msg = {
                id: generateUUID(),
                type: 'system',
                content: content,
                timestamp: Date.now()
            };

            chats[currentChatId].messages.push(msg);
            saveChatsToStorage();

            if (currentChatId) {
                renderMessages();
            }
        }
    }

    // å‘é€å·²è¯»å›æ‰§
    function sendReadReceipt(originalMessage) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            return;
        }

        const readReceiptMessage = {
            type: 'READ_RECEIPT',
            chatId: originalMessage.chatId,
            receiverId: originalMessage.senderId,
            extraData: {
                messageId: originalMessage.messageId
            },
            timestamp: Date.now()
        };

        ws.send(JSON.stringify(readReceiptMessage));
    }

    // å‘é€éšæœºæ¶ˆæ¯
    function sendRandomMessage() {
        const randomIndex = Math.floor(Math.random() * randomMessages.length);
        const randomLetters = Math.random().toString(36).substring(2, 5);
        const content = randomMessages[randomIndex] + ' ' + randomLetters;
        sendMessage(content);
    }

    // æµ‹è¯•æ¶ˆæ¯å‘é€å¤±è´¥
    function testMessageFailure() {
        if (!currentReceiverId || !currentChatId) {
            alert('è¯·å…ˆé€‰æ‹©èŠå¤©å¯¹è±¡');
            return;
        }

        // æ¨¡æ‹Ÿå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œç„¶ååœ¨3ç§’åå°†å…¶æ ‡è®°ä¸ºå¤±è´¥
        const tempMessageId = generateUUID();
        const testMessage = 'æµ‹è¯•å‘é€å¤±è´¥æ¶ˆæ¯ ' + Math.random().toString(36).substring(2, 5);

        // æ·»åŠ åˆ°å¾…ç¡®è®¤æ¶ˆæ¯
        pendingMessages[tempMessageId] = {
            content: testMessage,
            chatId: currentChatId,
            receiverId: currentReceiverId,
            timestamp: Date.now()
        };

        // å…ˆç”¨ä¸´æ—¶IDæ·»åŠ åˆ°æœ¬åœ°èŠå¤©è®°å½•
        addSentMessage(testMessage, tempMessageId);

        // 3ç§’åæ¨¡æ‹Ÿå¤±è´¥
        setTimeout(() => {
            if (pendingMessages[tempMessageId]) {
                debugLog(`æ¨¡æ‹Ÿæ¶ˆæ¯å‘é€å¤±è´¥: ${tempMessageId}`);
                updateMessageStatus(tempMessageId, 'failed');
                delete pendingMessages[tempMessageId];
                addSystemMessage('æ¨¡æ‹Ÿçš„æ¶ˆæ¯å‘é€å¤±è´¥');
            }
        }, 3000);

        debugLog(`å·²å‘é€æµ‹è¯•å¤±è´¥æ¶ˆæ¯: ${tempMessageId}`);
    }

    // æµ‹è¯•çŠ¶æ€æ˜¾ç¤ºä¼˜åŒ–
    function testStatusOptimization() {
        if (!currentReceiverId || !currentChatId) {
            alert('è¯·å…ˆé€‰æ‹©èŠå¤©å¯¹è±¡');
            return;
        }

        debugLog('å¼€å§‹æµ‹è¯•çŠ¶æ€æ˜¾ç¤ºä¼˜åŒ–');

        // å¿«é€Ÿå‘é€3æ¡æ¶ˆæ¯
        const messages = ['æ¶ˆæ¯1', 'æ¶ˆæ¯2', 'æ¶ˆæ¯3'];
        const tempIds = [];

        messages.forEach((content, index) => {
            const tempMessageId = generateUUID();
            tempIds.push(tempMessageId);

            // æ·»åŠ åˆ°æœ¬åœ°èŠå¤©è®°å½•
            addSentMessage(content, tempMessageId);

            // æ¨¡æ‹Ÿä¸åŒçš„çŠ¶æ€æ›´æ–°æ—¶æœº
            setTimeout(() => {
                // æ¨¡æ‹ŸdeliveredçŠ¶æ€
                updateMessageStatus(tempMessageId, 'delivered');
                debugLog(`æ¶ˆæ¯${index + 1}å·²é€è¾¾`);

                // å¦‚æœæ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œå†æ¨¡æ‹ŸreadçŠ¶æ€
                if (index === messages.length - 1) {
                    setTimeout(() => {
                        updateMessageStatus(tempMessageId, 'read');
                        debugLog(`æ¶ˆæ¯${index + 1}å·²è¯»`);
                    }, 2000);
                }
            }, (index + 1) * 1000);
        });

        addSystemMessage('å·²å‘é€3æ¡æµ‹è¯•æ¶ˆæ¯ï¼Œè§‚å¯ŸçŠ¶æ€æ˜¾ç¤ºä¼˜åŒ–æ•ˆæœ');
    }

    // æ£€æŸ¥è¶…æ—¶çš„å¾…ç¡®è®¤æ¶ˆæ¯
    function checkTimeoutMessages() {
        const now = Date.now();
        const timeoutThreshold = 30000; // 30ç§’è¶…æ—¶

        for (const [tempId, pendingMsg] of Object.entries(pendingMessages)) {
            if (now - pendingMsg.timestamp > timeoutThreshold) {
                debugLog(`æ¶ˆæ¯å‘é€è¶…æ—¶: ${tempId}`);
                updateMessageStatus(tempId, 'failed');
                delete pendingMessages[tempId];
                addSystemMessage('æ¶ˆæ¯å‘é€è¶…æ—¶');
            }
        }
    }

    // å¯åŠ¨å®šæ—¶å™¨æ£€æŸ¥è¶…æ—¶æ¶ˆæ¯
    setInterval(checkTimeoutMessages, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡

    // å¤„ç†è¾“å…¥æ¡†å›è½¦äº‹ä»¶
    function handleInputKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }

    // ä¿å­˜èŠå¤©åˆ°localStorage
    function saveChatsToStorage() {
        localStorage.setItem('chatHistory', JSON.stringify(chats));
        localStorage.setItem('messageStatuses', JSON.stringify(messageStatuses));
        localStorage.setItem('tempIdToRealIdMap', JSON.stringify(tempIdToRealIdMap));
    }

    // ä»localStorageåŠ è½½èŠå¤©
    function loadChatsFromStorage() {
        const saved = localStorage.getItem('chatHistory');
        if (saved) {
            try {
                chats = JSON.parse(saved);
            } catch (e) {
                console.error('Failed to load chat history:', e);
                chats = {};
            }
        }

        // åŠ è½½æ¶ˆæ¯çŠ¶æ€
        const savedStatuses = localStorage.getItem('messageStatuses');
        if (savedStatuses) {
            try {
                messageStatuses = JSON.parse(savedStatuses);
            } catch (e) {
                console.error('Failed to load message statuses:', e);
                messageStatuses = {};
            }
        }

        // åŠ è½½IDæ˜ å°„
        const savedIdMap = localStorage.getItem('tempIdToRealIdMap');
        if (savedIdMap) {
            try {
                tempIdToRealIdMap = JSON.parse(savedIdMap);
            } catch (e) {
                console.error('Failed to load ID map:', e);
                tempIdToRealIdMap = {};
            }
        }
    }

    // è°ƒè¯•ç›¸å…³å‡½æ•°
    function debugLog(message) {
        const timestamp = new Date().toLocaleTimeString();
        const debugContent = document.getElementById('debugContent');
        if (debugContent) {
            debugContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugContent.scrollTop = debugContent.scrollHeight;
        }
        console.log(message);
    }

    function toggleDebugPanel() {
        const panel = document.getElementById('debugPanel');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            debugLog('è°ƒè¯•é¢æ¿å·²æ‰“å¼€');
        } else {
            panel.style.display = 'none';
        }
    }

    function clearDebugLog() {
        const debugContent = document.getElementById('debugContent');
        if (debugContent) {
            debugContent.innerHTML = 'è°ƒè¯•æ—¥å¿—å·²æ¸…ç©º...';
        }
    }

    function showDebugInfo() {
        debugLog('=== è°ƒè¯•ä¿¡æ¯ ===');
        debugLog(`å½“å‰èŠå¤©ID: ${currentChatId}`);
        debugLog(`å½“å‰æ¥æ”¶è€…: ${currentReceiverId}`);
        debugLog(`å¾…ç¡®è®¤æ¶ˆæ¯æ•°é‡: ${Object.keys(pendingMessages).length}`);
        debugLog(`IDæ˜ å°„æ•°é‡: ${Object.keys(tempIdToRealIdMap).length}`);
        debugLog(`æ¶ˆæ¯çŠ¶æ€æ•°é‡: ${Object.keys(messageStatuses).length}`);

        if (Object.keys(pendingMessages).length > 0) {
            debugLog('å¾…ç¡®è®¤æ¶ˆæ¯: ' + JSON.stringify(pendingMessages));
        }

        if (Object.keys(tempIdToRealIdMap).length > 0) {
            debugLog('IDæ˜ å°„: ' + JSON.stringify(tempIdToRealIdMap));
        }

        if (Object.keys(messageStatuses).length > 0) {
            debugLog('æ¶ˆæ¯çŠ¶æ€: ' + JSON.stringify(messageStatuses));
        }
    }
</script>
</body>
</html>